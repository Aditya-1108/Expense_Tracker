{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-lg-5">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title text-white">Add Expense</h5>
        <form method="post" action="{{ url_for('add') }}">
          <div class="mb-2">
            <label class="form-label text-white">Date</label>
            <input name="date" type="date" class="form-control" value="{{ default_date }}">
          </div>

          <div class="mb-2">
            <label class="form-label text-white">Category</label>
            <select name="category" class="form-select">
              {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label text-white">Amount</label>
            <input name="amount" type="number" step="0.01" class="form-control" required>
          </div>

          <div class="mb-2">
            <label class="form-label text-white">Note</label>
            <input name="note" type="text" class="form-control">
          </div>

          <button class="btn btn-primary">Add Expense</button>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title text-white">Set Budget</h5>

        <form method="post" action="{{ url_for('set_budget') }}" class="row g-2">
          <div class="col-6">
            <select name="category" class="form-select">
              {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-6">
            <input name="amount" type="number" step="0.01" class="form-control" placeholder="Amount">
          </div>

          <div class="col-6">
            <input name="year" type="number" class="form-control" value="{{ default_year }}">
          </div>

          <div class="col-6">
            <input name="month" type="number" class="form-control" value="{{ default_month }}">
          </div>

          <div class="col-12 mt-2">
            <button class="btn btn-success">Save Budget</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title text-white">Add Recurring (Monthly)</h5>

        <form method="post" action="{{ url_for('add_recurring') }}" class="row g-2">
          <div class="col-6">
            <input name="start_date" type="date" class="form-control" value="{{ default_date }}">
          </div>

          <div class="col-6">
            <select name="category" class="form-select">
              {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-6">
            <input name="amount" type="number" step="0.01" class="form-control" placeholder="Amount">
          </div>

          <div class="col-6">
            <input name="note" type="text" class="form-control" placeholder="Note">
          </div>

          <div class="col-12">
            <button class="btn btn-outline-light">Add Recurring</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <div class="col-lg-7">
    {% if warnings %}
      {% for w in warnings %}
        <div class="alert alert-warning">{{ w }}</div>
      {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between mb-2">
      <h5 class="text-white">All Expenses</h5>
      <input id="searchBox" class="form-control form-control-sm w-50" placeholder="Search...">
    </div>

    <div class="card shadow-sm">
      <div class="card-body table-card-body">
        <div class="table-responsive" style="max-height:60vh; overflow:auto;">
          <table id="expensesTable" class="table table-sm table-dark table-striped mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th class="text-end">Amount</th>
                <th>Note</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for e in expenses %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.category }}</td>
                <td class="text-end">{{ '%.2f'|format(e.amount) }}</td>
                <td>{{ e.note }}</td>
                <td>
                  <form method="post" action="{{ url_for('delete', expense_id=e.id) }}" onsubmit="return confirm('Delete?');">
                    <button class="btn btn-danger btn-sm">X</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="card-title text-white">Monthly Report</h5>

        <div class="row g-2">
          <div class="col-4">
            <input id="report-year" type="number" class="form-control" value="{{ default_year }}">
          </div>
          <div class="col-4">
            <input id="report-month" type="number" class="form-control" value="{{ default_month }}">
          </div>
          <div class="col-4">
            <button id="btn-report" class="btn btn-success w-100">Show</button>
          </div>

          <div class="col-12 mt-3">
            <canvas id="pieChart" height="200"></canvas>
            <div id="report-total" class="text-white fw-bold mt-2"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
const ctx = document.getElementById('pieChart').getContext('2d');
let pie = new Chart(ctx, {
    type: 'pie',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: { responsive: true }
});

function randomColor() {
    return 'hsl(' + (Math.random()*360) + ',70%,60%)';
}

document.getElementById('btn-report').addEventListener('click', async function() {
    const year = document.getElementById('report-year').value;
    const month = document.getElementById('report-month').value;

    const res = await fetch(`/month_summary?year=${year}&month=${month}`);
    const j = await res.json();
    pie.data.labels = j.labels;
    pie.data.datasets[0].data = j.data;
    pie.data.datasets[0].backgroundColor = j.labels.map(_ => randomColor());
    pie.update();

    document.getElementById('report-total').innerText = "Total: " + j.total.toFixed(2);
});

document.getElementById('searchBox').addEventListener('input', function(){
    const q = this.value.toLowerCase();
    document.querySelectorAll("#expensesTable tbody tr").forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
    });
});
</script>

{% endblock %}
